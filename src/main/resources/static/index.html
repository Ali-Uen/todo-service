<!doctype html>
<html lang="de">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Todos</title>
<style>
  :root { font-family: system-ui, sans-serif; }
  body { margin: 2rem; max-width: 760px; }
  form { display: flex; gap: .5rem; margin-bottom: 1rem; }
  input, button { padding: .5rem .75rem; font-size: 1rem; }
  ul { list-style: none; padding: 0; margin: 0; }
  li { display: flex; align-items: center; justify-content: space-between; border: 1px solid #ddd; border-radius: .5rem; padding: .5rem .75rem; margin: .4rem 0; }
  .left { display: flex; align-items: center; gap: .6rem; }
  .title.done { text-decoration: line-through; opacity: .7; }
  .meta { color: #666; font-size: .9rem; }
  .actions { display: flex; gap: .4rem; }
</style>

<h1>Todo-App</h1>

<form id="f">
  <input id="title" placeholder="Neues Todo" required />
  <input id="desc" placeholder="Beschreibung (optional)" />
  <button id="add">Hinzufügen</button>
</form>

<ul id="list"></ul>

<script>
const API = '/api/v1/todos';
const list = document.querySelector('#list');
const form = document.querySelector('#f');
const titleInput = document.querySelector('#title');
const descInput  = document.querySelector('#desc');

async function api(url = '', opts = {}) {
  const r = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...opts });
  if (!r.ok) throw new Error(await r.text());
  return r.status !== 204 ? r.json() : null;
}

function toArray(data) {
  // Unterstützt Array oder Spring Page (content)
  if (Array.isArray(data)) return data;
  if (data && Array.isArray(data.content)) return data.content;
  return [];
}

function fmtDate(iso) {
  try { return new Date(iso).toLocaleString(); } catch { return ''; }
}

async function load() {
  const data = await api(API);
  render(toArray(data));
}

function render(items) {
  list.innerHTML = '';
  items.forEach(t => {
    const li = document.createElement('li');

    const left = document.createElement('div');
    left.className = 'left';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = !!t.completed;
    cb.addEventListener('change', () => toggle(t));

    const textWrap = document.createElement('div');
    const title = document.createElement('div');
    title.textContent = t.title;
    title.className = 'title' + (t.completed ? ' done' : '');
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = (t.description ? t.description + ' • ' : '') + (t.createdAt ? fmtDate(t.createdAt) : '');

    textWrap.appendChild(title);
    textWrap.appendChild(meta);

    left.appendChild(cb);
    left.appendChild(textWrap);

    const actions = document.createElement('div');
    actions.className = 'actions';
    const del = document.createElement('button');
    del.type = 'button';
    del.textContent = 'Löschen';
    del.addEventListener('click', () => remove(t));

    actions.appendChild(del);

    li.appendChild(left);
    li.appendChild(actions);
    list.appendChild(li);
  });
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = titleInput.value.trim();
  const description = descInput.value.trim();
  if (!title) return;

  await api(API, {
    method: 'POST',
    body: JSON.stringify({ title, description, completed: false })
  });
  titleInput.value = '';
  descInput.value = '';
  await load();
});

async function toggle(t) {
  // Annahme: Update via PUT /api/v1/todos/{id} mit vollständigem Objekt
  await api(`${API}/${t.id}`, {
    method: 'PUT',
    body: JSON.stringify({
      id: t.id,
      title: t.title,
      description: t.description,
      completed: !t.completed
    })
  });
  await load();
}

async function remove(t) {
  await api(`${API}/${t.id}`, { method: 'DELETE' });
  await load();
}

load().catch(err => {
  console.error(err);
  list.innerHTML = '<li>Fehler beim Laden. Siehe Konsole.</li>';
});
</script>
</html>
